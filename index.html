<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuesioner Usability - Petani Cerdas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4;
        }
        .form-container, .result-card, #login-container {
            transition: all 0.5s ease-in-out;
        }
        .hidden-fade {
            opacity: 0;
            visibility: hidden;
            height: 0;
            overflow: hidden;
            transform: scale(0.95);
            transition: all 0.5s ease-in-out;
        }
         .visible-fade {
            opacity: 1;
            visibility: visible;
            height: auto;
            transform: scale(1);
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- Google Login Container -->
        <div id="login-container" class="form-container visible-fade">
             <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-green-200 text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-green-800">Kuesioner Usability</h1>
                <p class="mt-2 text-gray-600 mb-6">Untuk melanjutkan, silakan login dengan akun Google Anda.</p>
                <div id="g_id_onload"
                     data-client_id="243170039839-vv0jnemmu8mj93jhmdpv1lsu8sqdgvbj.apps.googleusercontent.com"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-shape="rectangular"
                     data-theme="outline"
                     data-text="signin_with"
                     data-size="large"
                     data-logo_alignment="left">
                </div>
            </div>
        </div>

        <!-- Main Content (SUS Questionnaire) - Hidden by default -->
        <div id="main-content-container" class="hidden-fade form-container">
            <!-- Form Kuesioner -->
            <form id="sus-form" class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-green-200">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-green-800">Kuesioner System Usability Scale (SUS)</h1>
                    <p class="mt-2 text-gray-600">Berdasarkan pengalaman Anda menggunakan aplikasi, berikan penilaian Anda.</p>
                     <a href="https://fahmitrk24.github.io/Agromonitorp/" target="_blank" rel="noopener noreferrer" class="text-sm text-green-600 hover:underline mt-2 inline-block">
                        Buka kembali aplikasi "Petani Cerdas"
                    </a>
                </div>
                <div class="space-y-6">
                    <div id="questions-container" class="space-y-6">
                        <!-- Pertanyaan akan di-generate oleh JavaScript -->
                    </div>
                </div>
                <div class="mt-10 text-center">
                    <button type="submit" id="submit-button" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 shadow-md w-64 text-center">
                        Kirim Jawaban & Lihat Hasil
                    </button>
                </div>
            </form>
            <div id="sus-error-message" class="hidden mt-4 text-center text-red-600 font-semibold bg-red-100 p-3 rounded-lg">
                Harap jawab semua pertanyaan sebelum mengirim.
            </div>
        </div>

        <!-- Hasil Skor -->
        <div id="result-card" class="hidden-fade result-card mt-8 bg-white p-6 md:p-8 rounded-xl shadow-lg border border-green-200">
            <!-- Hasil akan ditampilkan di sini -->
        </div>
    </div>

    <script>
        // --- GANTI DENGAN URL DEPLOYMENT BARU ANDA JIKA ADA ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5QujChdHnlOEzeHoAdh2xvGy_9Y5N_C7iqnZckrH-2gDSq2vZdoXdFFI4jVA7VQqy/exec';

        // --- Global Variables ---
        let respondentData = {};

        // --- Helper function to parse JWT ---
        function parseJwt(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        // --- Google Sign-In Callback ---
        function handleCredentialResponse(response) {
            const credential = response.credential;
            const profile = parseJwt(credential);

            if (profile) {
                // Store Google data
                respondentData.nama = profile.name;
                respondentData.email = profile.email;

                // --- PERUBAHAN ALUR ---
                // Langsung tampilkan kuesioner setelah login berhasil
                document.getElementById('login-container').classList.remove('visible-fade');
                document.getElementById('login-container').classList.add('hidden-fade');
                document.getElementById('main-content-container').classList.remove('hidden-fade');
                document.getElementById('main-content-container').classList.add('visible-fade');
            } else {
                alert("Login Gagal. Silakan coba lagi.");
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const mainContentContainer = document.getElementById('main-content-container');
            const susForm = document.getElementById('sus-form');
            const susErrorMessage = document.getElementById('sus-error-message');
            const submitButton = document.getElementById('submit-button');
            const resultCard = document.getElementById('result-card');
            const questionsContainer = document.getElementById('questions-container');

            const questions = [
                { text: "Saya rasa saya akan sering menggunakan sistem ini.", type: 'odd' },
                { text: "Menurut saya, sistem ini terlalu rumit.", type: 'even' },
                { text: "Saya pikir sistem ini mudah digunakan.", type: 'odd' },
                { text: "Saya rasa saya akan membutuhkan bantuan teknis untuk bisa menggunakan sistem ini.", type: 'even' },
                { text: "Menurut saya, berbagai fungsi dalam sistem ini terintegrasi dengan baik.", type: 'odd' },
                { text: "Menurut saya, ada terlalu banyak hal yang tidak konsisten di sistem ini.", type: 'even' },
                { text: "Saya bayangkan kebanyakan orang akan belajar menggunakan sistem ini dengan sangat cepat.", type: 'odd' },
                { text: "Menurut saya, sistem ini sangat merepotkan saat digunakan.", type: 'even' },
                { text: "Saya merasa sangat percaya diri saat menggunakan sistem ini.", type: 'odd' },
                { text: "Saya perlu mempelajari banyak hal terlebih dahulu sebelum bisa menggunakan sistem ini.", type: 'even' }
            ];

            // Generate questions HTML
            questions.forEach((q, index) => {
                const questionIndex = index + 1;
                const questionElement = document.createElement('div');
                questionElement.className = 'p-4 rounded-lg border border-gray-200 hover:bg-gray-50';
                
                let optionsHTML = '';
                const scale = [
                    { value: 1, label: '1' },
                    { value: 2, label: '2' },
                    { value: 3, label: '3' },
                    { value: 4, label: '4' },
                    { value: 5, label: '5' }
                ];

                optionsHTML += '<div class="flex items-center justify-around w-full mt-2">';
                scale.forEach(item => {
                     optionsHTML += `
                        <label for="q${questionIndex}-${item.value}" class="flex flex-col items-center cursor-pointer p-2 rounded hover:bg-green-50">
                            <span class="text-sm font-medium">${item.label}</span>
                            <input type="radio" id="q${questionIndex}-${item.value}" name="q${questionIndex}" value="${item.value}" required class="h-5 w-5 mt-1 text-green-600 focus:ring-green-500 border-gray-300">
                        </label>
                    `;
                });
                optionsHTML += '</div>';

                questionElement.innerHTML = `
                    <p class="font-medium text-gray-700 text-center">${index + 1}. ${q.text}</p>
                    ${optionsHTML}
                `;
                questionsContainer.appendChild(questionElement);
            });
            
            susForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                susErrorMessage.classList.add('hidden');

                if (!susForm.checkValidity()) {
                    susErrorMessage.classList.remove('hidden');
                    return;
                }

                submitButton.disabled = true;
                submitButton.innerHTML = `<svg class="spinner -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Mengirim...`;

                let score = 0;
                const rawScores = [];

                for (let i = 0; i < questions.length; i++) {
                    const questionIndex = i + 1;
                    const questionType = questions[i].type;
                    const selectedOption = document.querySelector(`input[name="q${questionIndex}"]:checked`);
                    const value = parseInt(selectedOption.value);
                    
                    rawScores.push(value); 

                    if (questionType === 'odd') {
                        score += (value - 1);
                    } else {
                        score += (5 - value);
                    }
                }

                const finalScore = score * 2.5;
                
                const submissionData = {
                    timestamp: new Date().toISOString(),
                    nama: respondentData.nama,
                    email: respondentData.email,
                    susScore: finalScore,
                    answers: rawScores
                };

                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({submissionData: submissionData}),
                    });
                } catch (error) {
                    console.error('Error submitting to Google Sheets:', error);
                } finally {
                    displayResult(finalScore, rawScores);
                }
            });

            // --- PERUBAHAN TAMPILAN HASIL ---
            function displayResult(score, rawScores) {
                mainContentContainer.classList.remove('visible-fade');
                mainContentContainer.classList.add('hidden-fade');
                resultCard.classList.remove('visible-fade');
                resultCard.classList.add('visible-fade');

                let tableHeaders = '';
                let tableCells = '';
                rawScores.forEach((answer, index) => {
                    tableHeaders += `<th class="p-2 border border-gray-300 bg-gray-100">Q${index + 1}</th>`;
                    tableCells += `<td class="p-2 border border-gray-300 text-center">${answer}</td>`;
                });

                resultCard.innerHTML = `
                    <h2 class="text-2xl font-bold text-center text-green-800 mb-4">Terima Kasih!</h2>
                    <p class="text-center text-gray-600 mb-6">Jawaban Anda telah berhasil direkam. Berikut adalah rinciannya.</p>
                    
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Tabel Hasil Jawaban Responden</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr>
                                    ${tableHeaders}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    ${tableCells}
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-8 text-center border-t pt-6">
                        <p class="text-lg text-gray-600">Skor Akhir Usability (SUS) Anda:</p>
                        <p class="text-6xl font-bold text-green-700">${score.toFixed(1)}</p>
                         <div id="score-adjective" class="mt-2 text-xl font-semibold bg-green-100 text-green-800 px-4 py-2 rounded-lg inline-block"></div>
                    </div>
                `;
                
                let adjective = '';
                if (score > 80.3) { adjective = 'Sangat Baik'; } 
                else if (score > 68) { adjective = 'Baik'; }
                else if (score > 52) { adjective = 'Cukup'; }
                else { adjective = 'Buruk'; }
                document.getElementById('score-adjective').textContent = adjective;
            }
        });
    </script>
</body>
</html>


